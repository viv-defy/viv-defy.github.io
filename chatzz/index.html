<!DOCTYPE html>
<html lang="en" class="light">
  <head>
    <!-- Previous head content remains the same -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css"
      rel="stylesheet"
    />
    <style>
      /* Previous styles remain the same until the message group styles */
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f0f2f5;
        --text-primary: #1a1a1a;
        --text-secondary: #666666;
        --accent: #0084ff;
        --message-sent: #0084ff;
        --message-received: #e9ecef;
        --shadow: rgba(0, 0, 0, 0.1);
        --success: #4caf50;
      }

      .dark {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent: #2196f3;
        --message-sent: #2196f3;
        --message-received: #404040;
        --shadow: rgba(0, 0, 0, 0.3);
        --success: #81c784;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-secondary);
        height: 100vh;
        color: var(--text-primary);
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle:hover {
        background: var(--bg-secondary);
      }

      .login-container,
      .chat-container {
        max-width: 500px;
        margin: 20px auto;
        padding: 20px;
        background: var(--bg-primary);
        border-radius: 12px;
        box-shadow: 0 2px 4px var(--shadow);
      }

      .login-container {
        text-align: center;
      }

      .chat-container {
        display: none;
        height: 80vh;
        flex-direction: column;
      }

      h1 {
        margin-bottom: 20px;
        color: var(--text-primary);
        font-size: 1.5rem;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid var(--message-received);
        border-radius: 8px;
        font-size: 16px;
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      input[type="text"]::placeholder {
        color: var(--text-secondary);
      }

      button {
        background: var(--accent);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      button:hover {
        opacity: 0.9;
      }

      #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .message-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
        max-width: 80%;
      }

      .message-group.sent {
        align-self: flex-end;
      }

      .message-group.received {
        align-self: flex-start;
      }

      .message-group .sender {
        font-size: 0.8em;
        margin-bottom: 4px;
        color: var(--text-secondary);
        padding-left: 12px;
      }

      .message {
        padding: 10px 15px;
        word-wrap: break-word;
        position: relative;
        margin: 2px 0;
      }

      .message-group.received .message {
        background: var(--message-received);
        color: var(--text-primary);
        border-radius: 0 15px 15px 15px;
      }

      .message-group.received .message:first-of-type {
        border-radius: 15px 15px 15px 15px;
      }

      .message-group.sent .message {
        background: var(--message-sent);
        color: white;
        border-radius: 15px 0 15px 15px;
      }

      .message-group.sent .message:first-of-type {
        border-radius: 15px 15px 15px 15px;
      }

      #message-form {
        display: flex;
        gap: 10px;
        padding: 20px;
        background: var(--bg-primary);
      }

      #message-input {
        flex-grow: 1;
      }

      #send-button {
        padding: 12px;
        border-radius: 50%;
        width: 45px;
        height: 45px;
      }

      .status {
        color: var(--text-secondary);
        font-size: 0.9em;
        text-align: center;
        padding: 5px;
      }

      .system-message {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        margin: 10px 0;
        font-size: 0.9em;
      }
    </style>
  </head>
  <!-- Rest of the HTML remains the same until the script -->
  <body>
    <button class="theme-toggle" id="theme-toggle">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="12" r="5" />
        <path
          d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
        />
      </svg>
    </button>

    <div class="login-container" id="login-screen">
      <h1>Join Chat</h1>
      <form id="login-form">
        <input
          type="text"
          id="username"
          placeholder="Enter your name"
          required
        />
        <button type="submit">Join Chat</button>
      </form>
    </div>

    <div class="chat-container" id="chat-screen">
      <div id="messages"></div>
      <div class="status" id="status"></div>
      <form id="message-form">
        <input
          type="text"
          id="message-input"
          placeholder="Type a message..."
          required
        />
        <button type="submit" id="send-button">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
          </svg>
        </button>
      </form>
    </div>

    <script>
      // Previous JavaScript code remains the same until the addMessage function
      const themeToggle = document.getElementById("theme-toggle");
      const html = document.documentElement;

      themeToggle.addEventListener("click", () => {
        html.classList.toggle("dark");
        updateThemeIcon();
      });

      function updateThemeIcon() {
        const isDark = html.classList.contains("dark");
        themeToggle.innerHTML = isDark
          ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
          : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';
      }

      class MessageQueue {
        constructor() {
          this.queue = [];
          this.isProcessing = false;
        }

        add(message) {
          this.queue.push(message);
          if (!this.isProcessing) {
            this.process();
          }
        }

        async process() {
          if (this.queue.length === 0) {
            this.isProcessing = false;
            return;
          }

          this.isProcessing = true;
          const message = this.queue[0];

          try {
            await new Promise((resolve) => setTimeout(resolve, 500));
            this.queue.shift();
            this.updateStatus();
            this.process();
          } catch (error) {
            console.error("Error sending message:", error);
            setTimeout(() => this.process(), 1000);
          }
        }

        updateStatus() {
          const statusElement = document.getElementById("status");
          if (this.queue.length > 0) {
            statusElement.textContent = `Sending ${this.queue.length} message(s)...`;
          } else {
            statusElement.textContent = "All messages sent";
            setTimeout(() => {
              statusElement.textContent = "";
            }, 2000);
          }
        }
      }

      const messageQueue = new MessageQueue();
      let username = "";
      let currentSender = null;

      document.getElementById("login-form").addEventListener("submit", (e) => {
        e.preventDefault();
        username = document.getElementById("username").value.trim();
        if (username) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("chat-screen").style.display = "flex";
          addSystemMessage(`Welcome ${username}! You've joined the chat.`);
        }
      });

      document
        .getElementById("message-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const input = document.getElementById("message-input");
          const message = input.value.trim();

          if (message) {
            addMessage(message, username, true);
            messageQueue.add({
              text: message,
              sender: username,
              timestamp: new Date().toISOString(),
            });
            input.value = "";
          }
        });

      function addMessage(text, sender, isSent = false) {
        const messagesDiv = document.getElementById("messages");
        let messageGroup;

        if (currentSender !== sender) {
          messageGroup = document.createElement("div");
          messageGroup.className = `message-group ${
            isSent ? "sent" : "received"
          }`;

          const senderElement = document.createElement("div");
          senderElement.className = "sender";
          senderElement.textContent = sender;
          messageGroup.appendChild(senderElement);

          currentSender = sender;
          messagesDiv.appendChild(messageGroup);
        } else {
          messageGroup = messagesDiv.lastElementChild;
        }

        const messageElement = document.createElement("div");
        messageElement.className = "message";
        messageElement.textContent = text;
        messageGroup.appendChild(messageElement);

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(text) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.className = "system-message";
        messageElement.textContent = text;
        messagesDiv.appendChild(messageElement);
        currentSender = null;
      }

      // Simulate receiving messages
      setInterval(() => {
        const randomUsers = ["Alice", "Bob", "Charlie", "David"];
        const randomMessages = [
          "Hey everyone!",
          "How's it going?",
          "Nice to see you all here!",
          "What's new?",
        ];

        if (Math.random() < 0.3 && username) {
          const randomUser =
            randomUsers[Math.floor(Math.random() * randomUsers.length)];
          if (randomUser !== username) {
            const randomMessage =
              randomMessages[Math.floor(Math.random() * randomMessages.length)];
            addMessage(randomMessage, randomUser, false);
          }
        }
      }, 5000);

      // Initial theme icon
      updateThemeIcon();
    </script>
  </body>
</html>
